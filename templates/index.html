<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Monitor - Fog + Edge Computing</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .material-icons {
            font-size: 36px;
            color: #667eea;
        }

        .status-badge {
            background: #4caf50;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 500;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            margin: 0 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #ff5722;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e64a19;
        }

        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .layer-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 350px;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .layer-card:hover {
            transform: translateY(-5px);
        }

        .layer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }

        .layer-card.edge::before {
            background: #2196F3;
        }

        .layer-card.fog::before {
            background: #FF9800;
        }

        .layer-card.cloud::before {
            background: #4CAF50;
        }

        .layer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .layer-header .material-icons {
            font-size: 32px;
        }

        .layer-card.edge .material-icons {
            color: #2196F3;
        }

        .layer-card.fog .material-icons {
            color: #FF9800;
        }

        .layer-card.cloud .material-icons {
            color: #4CAF50;
        }

        .layer-header h2 {
            font-size: 22px;
            color: #333;
        }

        .metric {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .congestion-badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .congestion-low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .congestion-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .congestion-high {
            background: #ffebee;
            color: #c62828;
        }

        .console-panel {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 400px;
            overflow-y: auto;
        }

        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .console-header h3 {
            color: #4caf50;
            font-size: 18px;
            font-family: 'Courier New', monospace;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-info {
            color: #2196F3;
        }

        .log-success {
            color: #4CAF50;
        }

        .log-warning {
            color: #FF9800;
        }

        .log-error {
            color: #f44336;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .info-section p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .charts-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border-top: 4px solid #667eea;
        }
        
        .charts-section h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
            margin-top: 16px;
        }

        .chart-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
            padding: 16px;
            border-radius: 12px;
            height: 280px;
            border: 1px solid #e8ecf1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .chart-container:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        
        .chart-container:last-child {
            grid-column: 1 / -1;
            max-width: 50%;
            margin: 0 auto;
        }

        .chart-container h4 {
            color: #333;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 18px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card.stat-blue {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .stat-card.stat-orange {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .stat-card.stat-green {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }
        
        .stat-card.stat-red {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .architecture-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container:last-child {
                max-width: 100%;
            }
        }

        .location-filter-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-controls select {
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            color: #333;
        }

        .filter-controls button {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-card h4 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .comparison-stat:last-child {
            border-bottom: none;
        }

        .comparison-stat-label {
            color: #666;
            font-weight: 500;
        }

        .comparison-stat-value {
            color: #333;
            font-weight: 700;
        }

        .selected-locations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .location-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            line-height: 1;
        }

        .no-comparison-message {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="material-icons">traffic</span>
                Smart Traffic Monitoring System
            </h1>
            <div class="status-badge">System Active</div>
        </div>

        <div class="control-panel">
            <h2 style="margin-bottom: 15px; color: #333;">Control Panel</h2>
            <p style="color: #666; margin-bottom: 20px;">Simulate edge device sending traffic data through Fog to Cloud</p>
            <button class="btn-primary" onclick="sendTrafficData()">
                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                Send Traffic Data
            </button>
            <button class="btn-primary" onclick="sendConcurrentData()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">multiple_stop</span>
                Send Concurrent (3 Devices)
            </button>
            <button class="btn-secondary" onclick="clearLogs()">Clear Logs</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px; color: #666;">Processing...</p>
            </div>
        </div>

        <div class="location-filter-section">
            <h2 style="margin-bottom: 15px; color: #333;">
                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">location_on</span>
                Location-Based Analysis
            </h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Compare traffic patterns across different locations</p>
            
            <div class="filter-controls">
                <select id="locationSelect" onchange="loadLocationData()">
                    <option value="">-- Select Location --</option>
                </select>
                <button onclick="addLocationToComparison()">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">add</span>
                    Add to Compare
                </button>
                <button onclick="compareLocations()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">analytics</span>
                    Compare Selected
                </button>
                <button onclick="clearLocationComparison()" style="background: #f44336;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">close</span>
                    Clear
                </button>
            </div>

            <div id="selectedLocationsList" class="selected-locations-list"></div>
            <div id="locationStats" style="margin-top: 20px;"></div>
            <div id="comparisonResults"></div>
        </div>

        <div class="architecture-grid">
            <div class="layer-card edge">
                <div class="layer-header">
                    <span class="material-icons">camera_outdoor</span>
                    <h2>Edge Layer</h2>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">IoT Sensors & Cameras</p>
                <div class="metric">
                    <span class="metric-label">Device ID:</span>
                    <span class="metric-value" id="edge-device">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Location:</span>
                    <span class="metric-value" id="edge-location" style="font-size: 14px;">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Vehicle Count:</span>
                    <span class="metric-value" id="edge-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Latency:</span>
                    <span class="metric-value" id="edge-latency" style="font-size: 16px; color: #2196F3;">- ms</span>
                </div>
            </div>

            <div class="layer-card fog">
                <div class="layer-header">
                    <span class="material-icons">router</span>
                    <h2>Fog Layer</h2>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Intermediate Processing</p>
                <div class="metric">
                    <span class="metric-label">Congestion:</span>
                    <span class="congestion-badge congestion-low" id="fog-congestion">Low</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Decision:</span>
                    <span class="metric-value" id="fog-decision" style="font-size: 14px;">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Filtered:</span>
                    <span class="metric-value" id="fog-filtered">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Latency:</span>
                    <span class="metric-value" id="fog-latency" style="font-size: 16px; color: #FF9800;">- ms</span>
                </div>
            </div>

            <div class="layer-card cloud">
                <div class="layer-header">
                    <span class="material-icons">cloud</span>
                    <h2>Cloud Layer</h2>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Heavy Analytics & Storage</p>
                <div class="metric">
                    <span class="metric-label">Action:</span>
                    <span class="metric-value" id="cloud-action" style="font-size: 14px;">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Records:</span>
                    <span class="metric-value" id="cloud-records">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" id="cloud-status" style="font-size: 14px;">Ready</span>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <h3 style="margin-bottom: 3px; font-size: 22px; font-weight: 700;">ðŸ“Š Real-Time Traffic Analytics</h3>
            <p style="color: #888; margin-bottom: 20px; font-size: 13px;">Live visualization of traffic patterns and fog processing decisions</p>
            
            <div class="stats-row">
                <div class="stat-card stat-blue">
                    <div class="stat-label">Total Vehicles</div>
                    <div class="stat-value" id="stat-vehicles">0</div>
                </div>
                <div class="stat-card stat-orange">
                    <div class="stat-label">Avg Congestion</div>
                    <div class="stat-value" id="stat-congestion">-</div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-label">Cloud Filtered</div>
                    <div class="stat-value" id="stat-filtered">0</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h4><span class="material-icons" style="font-size: 18px;">trending_up</span>Vehicle Count Over Time</h4>
                    <canvas id="vehicleChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4><span class="material-icons" style="font-size: 18px;">pie_chart</span>Congestion Levels</h4>
                    <canvas id="congestionChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4><span class="material-icons" style="font-size: 18px;">analytics</span>Fog Processing Decisions</h4>
                    <canvas id="fogDecisionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="console-panel">
            <div class="console-header">
                <h3>â–¶ SYSTEM CONSOLE LOGS</h3>
                <span style="color: #888; font-size: 12px;">Real-time Data Flow</span>
            </div>
            <div id="console-logs">
                <div class="log-entry log-success">
                    <span class="log-timestamp">[SYSTEM]</span> Smart Traffic Monitoring System Ready...
                </div>
                <div class="log-entry log-info">
                    <span class="log-timestamp">[INFO]</span> Click "Send Traffic Data" to simulate Edge â†’ Fog â†’ Cloud flow
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>ðŸ’¡ About Fog + Edge Computing</h3>
            <p><strong>Edge Computing:</strong> Processing data at the source (sensors/cameras) for ultra-low latency responses.</p>
            <p><strong>Fog Computing:</strong> Intermediate layer between Edge and Cloud that processes data closer to the source, reducing latency and cloud load.</p>
            <p><strong>Why Fog Reduces Latency:</strong> By filtering and processing data locally, only critical information goes to the cloud, reducing network delays and bandwidth usage.</p>
            <p><strong>This Project:</strong> Simulates a traffic monitoring system where edge devices detect vehicles, fog nodes make quick decisions, and cloud handles heavy analytics only when needed.</p>
        </div>
    </div>

    <script>
        let logCount = 0;
        let vehicleChart, congestionChart, fogDecisionChart;

        function initCharts() {
            const vehicleCtx = document.getElementById('vehicleChart').getContext('2d');
            vehicleChart = new Chart(vehicleCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Vehicle Count',
                        data: [],
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        filler: {
                            propagate: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 120,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 20
                        }
                    }
                }
            });

            const congestionCtx = document.getElementById('congestionChart').getContext('2d');
            congestionChart = new Chart(congestionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            const fogCtx = document.getElementById('fogDecisionChart').getContext('2d');
            fogDecisionChart = new Chart(fogCtx, {
                type: 'bar',
                data: {
                    labels: ['Handled Locally', 'Sent to Cloud'],
                    datasets: [{
                        label: 'Fog Decisions',
                        data: [0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 20
                        }
                    }
                }
            });
        }

        async function updateCharts() {
            try {
                const response = await fetch('/api/chart-data');
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const data = result.data;
                    const maxDataPoints = 15;
                    
                    let labels = data.labels;
                    let vehicleData = data.vehicle_counts;
                    
                    if (labels.length > maxDataPoints) {
                        labels = labels.slice(-maxDataPoints);
                        vehicleData = vehicleData.slice(-maxDataPoints);
                    }
                    
                    vehicleChart.data.labels = labels;
                    vehicleChart.data.datasets[0].data = vehicleData;
                    vehicleChart.update();
                    
                    const lowCount = data.congestion_levels.filter(l => l === 'Low').length;
                    const mediumCount = data.congestion_levels.filter(l => l === 'Medium').length;
                    const highCount = data.congestion_levels.filter(l => l === 'High').length;
                    
                    congestionChart.data.datasets[0].data = [lowCount, mediumCount, highCount];
                    congestionChart.update();
                    
                    const localCount = data.sent_to_cloud.filter(s => !s).length;
                    const cloudCount = data.sent_to_cloud.filter(s => s).length;
                    
                    fogDecisionChart.data.datasets[0].data = [localCount, cloudCount];
                    fogDecisionChart.update();
                    
                    updateStatsCards(data);
                }
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }
        
        function updateStatsCards(data) {
            const totalVehicles = data.vehicle_counts.reduce((a, b) => a + b, 0);
            document.getElementById('stat-vehicles').textContent = totalVehicles;
            
            const congestionLevels = data.congestion_levels;
            const avgCongestion = congestionLevels.length > 0 ? 
                (congestionLevels.filter(l => l === 'High').length / congestionLevels.length * 100).toFixed(0) + '%' : '-';
            document.getElementById('stat-congestion').textContent = avgCongestion;
            
            const filteredLocally = data.sent_to_cloud.filter(s => !s).length;
            document.getElementById('stat-filtered').textContent = filteredLocally;
        }

        window.addEventListener('load', () => {
            initCharts();
            updateCharts();
            setInterval(updateCharts, 3000);
        });

        async function sendTrafficData() {
            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('/edge/send-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    updateUI(result);
                    await fetchLogs();
                    await updateCharts();
                }
            } catch (error) {
                console.error('Error:', error);
                addLogToUI('ERROR', 'Failed to send data: ' + error.message, 'error');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        async function sendConcurrentData() {
            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';

            try {
                const response = await fetch('/edge/send-concurrent-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ num_devices: 3 })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    await fetchLogs();
                    await updateCharts();
                    
                    const stats = await fetch('/api/stats').then(r => r.json());
                    if (stats.fog) {
                        document.getElementById('fog-filtered').textContent = stats.fog.filtered_locally;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function updateUI(result) {
            document.getElementById('edge-device').textContent = result.edge_data.device_id;
            document.getElementById('edge-location').textContent = result.edge_data.location;
            document.getElementById('edge-count').textContent = result.edge_data.vehicle_count;
            document.getElementById('edge-latency').textContent = result.latency.edge_to_fog_ms + ' ms';

            const congestion = result.fog_result.data.congestion_level;
            const congestionEl = document.getElementById('fog-congestion');
            congestionEl.textContent = congestion;
            congestionEl.className = 'congestion-badge congestion-' + congestion.toLowerCase();

            document.getElementById('fog-decision').textContent = result.fog_result.fog_decision;
            document.getElementById('fog-latency').textContent = result.latency.fog_to_cloud_ms + ' ms';

            if (result.cloud_response) {
                document.getElementById('cloud-action').textContent = result.cloud_response.analytics.action_required;
                document.getElementById('cloud-records').textContent = result.cloud_response.record_id;
                document.getElementById('cloud-status').textContent = 'Stored';
            } else {
                document.getElementById('cloud-status').textContent = 'Not Used';
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const result = await response.json();

                const consoleEl = document.getElementById('console-logs');
                consoleEl.innerHTML = '';

                result.logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry log-' + log.type;
                    logEntry.innerHTML = `<span class="log-timestamp">[${log.timestamp}]</span> ${log.message}`;
                    consoleEl.appendChild(logEntry);
                });

                consoleEl.scrollTop = consoleEl.scrollHeight;
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        async function clearLogs() {
            try {
                await fetch('/api/clear-logs', { method: 'POST' });
                document.getElementById('console-logs').innerHTML = `
                    <div class="log-entry log-success">
                        <span class="log-timestamp">[SYSTEM]</span> Logs cleared successfully
                    </div>
                `;
                
                // Clear all charts
                vehicleChart.data.labels = [];
                vehicleChart.data.datasets[0].data = [];
                vehicleChart.update();
                
                congestionChart.data.datasets[0].data = [0, 0, 0];
                congestionChart.update();
                
                fogDecisionChart.data.datasets[0].data = [0, 0];
                fogDecisionChart.update();
            } catch (error) {
                console.error('Error clearing logs:', error);
            }
        }

        setInterval(fetchLogs, 2000);

        // Location Filtering Functions
        let selectedLocations = [];

        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const selectEl = document.getElementById('locationSelect');
                    result.locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location;
                        option.textContent = location;
                        selectEl.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        async function loadLocationData() {
            const location = document.getElementById('locationSelect').value;
            if (!location) {
                document.getElementById('locationStats').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/location-stats/${location}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    let statsHtml = `
                        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">ðŸ“Š ${result.location} Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <span style="color: #999; font-size: 12px;">Peak Vehicles</span>
                                    <div style="font-size: 24px; font-weight: 700; color: #2196F3;">${data.peak_vehicles}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <span style="color: #999; font-size: 12px;">Avg Congestion</span>
                                    <div style="font-size: 24px; font-weight: 700; color: #FF9800;">${data.avg_congestion}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <span style="color: #999; font-size: 12px;">Total Readings</span>
                                    <div style="font-size: 24px; font-weight: 700; color: #4CAF50;">${data.total_readings}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('locationStats').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('Error loading location data:', error);
            }
        }

        function addLocationToComparison() {
            const location = document.getElementById('locationSelect').value;
            if (!location) {
                alert('Please select a location');
                return;
            }
            
            if (!selectedLocations.includes(location)) {
                selectedLocations.push(location);
                updateSelectedLocationsList();
            }
        }

        function removeLocationFromComparison(location) {
            selectedLocations = selectedLocations.filter(l => l !== location);
            updateSelectedLocationsList();
        }

        function updateSelectedLocationsList() {
            const container = document.getElementById('selectedLocationsList');
            if (selectedLocations.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<h4 style="color: #666; margin-bottom: 10px;">Selected Locations:</h4>';
            selectedLocations.forEach(location => {
                html += `
                    <span class="location-tag">
                        <span class="material-icons" style="font-size: 14px;">location_on</span>
                        ${location}
                        <button onclick="removeLocationFromComparison('${location}')" title="Remove">Ã—</button>
                    </span>
                `;
            });
            container.innerHTML = html;
        }

        async function compareLocations() {
            if (selectedLocations.length === 0) {
                alert('Please select at least one location to compare');
                return;
            }

            try {
                const response = await fetch('/api/compare-locations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ locations: selectedLocations })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayComparisonResults(result.comparison);
                }
            } catch (error) {
                console.error('Error comparing locations:', error);
            }
        }

        function displayComparisonResults(comparison) {
            let html = '<h3 style="color: #667eea; margin-top: 30px; margin-bottom: 20px;">ðŸ”„ Comparison Results</h3>';
            html += '<div class="comparison-grid">';
            
            Object.keys(comparison).forEach(location => {
                const stats = comparison[location];
                const congestionColor = stats.congestion_percentage > 50 ? '#f44336' : stats.congestion_percentage > 25 ? '#FF9800' : '#4CAF50';
                
                html += `
                    <div class="comparison-card">
                        <h4>
                            <span class="material-icons" style="color: #667eea;">place</span>
                            ${location}
                        </h4>
                        <div class="comparison-stat">
                            <span class="comparison-stat-label">Avg Vehicles:</span>
                            <span class="comparison-stat-value">${Math.round(stats.avg_vehicles)}</span>
                        </div>
                        <div class="comparison-stat">
                            <span class="comparison-stat-label">Peak Vehicles:</span>
                            <span class="comparison-stat-value">${Math.round(stats.peak_vehicles)}</span>
                        </div>
                        <div class="comparison-stat">
                            <span class="comparison-stat-label">Congestion %:</span>
                            <span class="comparison-stat-value" style="color: ${congestionColor};">${Math.round(stats.congestion_percentage)}%</span>
                        </div>
                        <div class="comparison-stat">
                            <span class="comparison-stat-label">High Alerts:</span>
                            <span class="comparison-stat-value">${stats.total_high_alerts}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('comparisonResults').innerHTML = html;
        }

        function clearLocationComparison() {
            selectedLocations = [];
            document.getElementById('locationStats').innerHTML = '';
            document.getElementById('selectedLocationsList').innerHTML = '';
            document.getElementById('comparisonResults').innerHTML = '';
            document.getElementById('locationSelect').value = '';
        }

        // Initialize locations on page load
        window.addEventListener('load', () => {
            loadLocations();
        });
    </script>
</body>
</html>
